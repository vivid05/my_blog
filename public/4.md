# HTTP 缓存技术分享

## 概述

HTTP 缓存的类型，包括强制缓存、协商缓存和启发式缓存。

---

## HTTP 缓存类型

### 1. 强制缓存

#### 简介

强制缓存（Forced Caching）是客户端根据服务器响应的缓存控制指令（如 `Cache-Control` 或 `Expires`），在指定时间内直接使用本地缓存，无需与服务器通信。这种缓存机制简单高效，适用于资源变化不频繁的场景。

#### 工作原理

- **相关头信息**：
  - `Cache-Control: max-age=<seconds>`：指定资源在客户端缓存的有效时间（单位：秒）。例如 `max-age=3600` 表示缓存 1 小时。
  - `Expires: <date>`：指定资源过期的时间点，例如 `Expires: Wed, 05 Mar 2025 06:51:19 GMT`。
- **流程**：
  1. 客户端首次请求资源，服务器返回 `200 OK` 及缓存指令。
  2. 客户端缓存资源，并在有效期内直接使用本地副本。
  3. 有效期内，浏览器不会向服务器发送请求。
  4. 过期后，缓存失效，触发新请求或校验。
- **示例**：
  - 响应头：`Cache-Control: max-age=3600`
  - 客户端在 1 小时内重用缓存，之后重新请求。

#### 优缺点

- **优点**：
  - 减少服务器和网络负载。
  - 提高页面加载速度，优化用户体验。
- **缺点**：
  - 如果资源频繁更新，缓存可能导致用户看到过时内容。
  - 依赖服务器正确配置有效期。

#### 应用场景

- 静态资源（如图片、CSS、JS 文件）。
- 内容较稳定的页面。

---

### 2. 协商缓存

#### 简介

协商缓存（Negotiated Caching 或 Conditional Caching）是当强制缓存失效或未配置时，客户端通过条件请求与服务器协商，验证缓存是否仍然有效。服务器返回 `304 Not Modified` 表示缓存可用，或 `200 OK` 提供新内容。

#### 工作原理

- **相关头信息**：
  - `Last-Modified`：服务器返回资源的最后修改时间。
  - `If-Modified-Since`：客户端发送的条件请求头，与 `Last-Modified` 对比。
  - `ETag`：资源的唯一标识符。
  - `If-None-Match`：客户端发送的条件请求头，与 `ETag` 对比。
- **流程**：
  1. 首次请求，服务器返回 `200 OK` 并附带 `Last-Modified` 或 `ETag`。
  2. 客户端缓存资源及其验证信息。
  3. 下次请求，客户端发送 `If-Modified-Since` 或 `If-None-Match`。
  4. 服务器验证：
     - 未修改：返回 `304 Not Modified`，客户端重用缓存。
     - 已修改：返回 `200 OK` 及新内容。
- **示例**：
  - 响应头：`Last-Modified: Wed, 26 Feb 2025 08:29:17 GMT`
  - 请求头：`If-Modified-Since: Wed, 26 Feb 2025 08:29:17 GMT`
  - 服务器返回 `304`，客户端使用缓存。

#### 优缺点

- **优点**：
  - 确保资源更新时获取最新内容。
  - `304` 响应仅包含头信息，传输量小。
- **缺点**：
  - 每次请求都需要与服务器交互，增加延迟。
  - 依赖 `Last-Modified` 或 `ETag` 的准确性。

#### 应用场景

- 动态内容或变化频率适中的资源。
- 需要验证缓存有效性的场景（如 `Cache-Control: no-cache`）。

#### 特殊情况：`Cache-Control: no-cache`

- 配置 `Cache-Control: no-cache` 后，强制每次请求校验，基于 `Last-Modified` 或 `ETag` 进行协商缓存。

---

### 3. 启发式缓存

#### 简介

启发式缓存（Heuristic Caching）是当服务器响应中未提供 `Cache-Control` 或 `Expires` 时，客户端根据现有信息（如 `Last-Modified`）估算缓存有效期。这种机制是 HTTP 协议的默认行为，旨在在缺乏明确指令时仍提供缓存支持。

#### 工作原理

- **相关头信息**：
  - `Last-Modified`：资源的最后修改时间。
  - `Date`：响应生成时间（用于计算时间差）。
- **估算公式**：
  - 有效期 = (浏览器首次下载资源时间 - Last-Modified 日期) × 因子
  - 因子：RFC 7234 建议 0.1（10%）到 0.5（50%），浏览器通常使用 10%。
  - 上限：通常限制为 24 小时（86400 秒）。
- **流程**：
  1. 客户端根据 `Last-Modified` 和 `Date` 计算有效期。
  2. 有效期内直接使用缓存。
  3. 过期后发送条件请求（如 `If-Modified-Since`）验证。
- **示例**：
  - `Date: Tue, 04 Mar 2025 06:51:19 GMT`
  - `Last-Modified: Wed, 26 Feb 2025 08:29:17 GMT`
  - 时间差 ≈ 604,540 秒，10% ≈ 60,454 秒（约 16.8 小时，限制为 24 小时）。
  - 24 小时内缓存，之后触发校验。

#### 优缺点

- **优点**：
  - 在无明确缓存指令时减少请求，提升性能。
  - 动态适应资源变化频率。
- **缺点**：
  - 估算不准确，可能导致缓存过时或未命中。
  - 依赖 `Last-Modified` 的正确性，若缺失则失效。

#### 应用场景

- 旧服务器或未配置缓存的资源。
- 临时解决方案，建议显式配置替代。

---

## 缓存类型对比

| 类型     | 触发校验时机           | 依赖头信息                 | 性能影响       | 适用场景           |
| -------- | ---------------------- | -------------------------- | -------------- | ------------------ |
| 强制缓存 | 缓存过期               | `Cache-Control`, `Expires` | 低（无交互）   | 静态资源           |
| 协商缓存 | 强制缓存失效或手动触发 | `Last-Modified`, `ETag`    | 中（条件请求） | 动态或验证需求资源 |

---

## 总结

HTTP 缓存通过强制缓存、协商缓存和启发式缓存三种机制，实现了性能与实时性的平衡。强制缓存适合静态资源，协商缓存确保动态内容更新，启发式缓存为未配置场景提供支持。理解其工作原理并根据实际需求配置，是提升 Web 应用效率的关键。
